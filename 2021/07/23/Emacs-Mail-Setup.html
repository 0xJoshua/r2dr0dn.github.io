<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>2021-07-23-Emacs-Mail-Setup.html</title>
<meta http-equiv="Content-Type" content="application/xhtml+xml;charset=utf-8"/>
<link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"  />
<link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css"  /><meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'><style> body { box-sizing: border-box; max-width: 740px; width: 100%; margin: 40px auto; padding: 0 10px; } </style><script id='MathJax-script' async src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script><script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script><script>document.addEventListener('DOMContentLoaded', () => { document.body.classList.add('markdown-body'); document.querySelectorAll('pre[lang] > code').forEach((code) => { code.classList.add(code.parentElement.lang); }); document.querySelectorAll('pre > code').forEach((code) => { hljs.highlightBlock(code); }); });</script>
</head>

<body>

<hr />

<p>layout: post
title: &ldquo;How To Setup Mail In Emacs&rdquo;
categories: Emacs
toc: true
tags: [emacs, mail, offlineimap, mu, mu4e, mbsync, isync, oauth2, gmail]
last_modified_at: 2021-09-21
author:</p>

<h2>  - ybenel</h2>

<p>If you&rsquo;re an emacs user and love using emacs for literally everything , then you are in the right place.
In This Short Tutorial we are gonna learn how to setup Mu4e In Emacs From Scratch.</p>

<h2>Installing Mu4e</h2>

<p>There&rsquo;s a lot of ways to install mu4e in emacs , one of the easiest ways to do it if you have <strong>doom emacs</strong> installed is to edit init.el and uncomment the mail option <em>mu4e</em>.
the other way is to install it manually which we will cover it later on in mu installation.</p>

<h2>Installing and mu-git and mu4e</h2>

<p>In order to index our mail we&rsquo;ll be using <em>mu</em> which includes <em>mu4e</em> for emacs.
There&rsquo;s few different ways to install <em>mu</em> which changes from distribution to another.
The current stable release is <strong>1.6.6</strong>, in case u installed 1.7.0 there&rsquo;s a high chance you&rsquo;ll be facing few problems and experiencing some bugs , so be sure which version you&rsquo;re installing .
In <strong>Arch</strong> Using <em>AUR</em> is pretty straight forward.
<code>bash
yay -S offlineimap mu-git
</code>
In <strong>Debian</strong> the stable release is 1.4.15 which is really fine really, you can use the instable repositories to install 1.6.<em>
<code>bash
apt install mu4e
</code>
In Case your distribution doesn&rsquo;t have </em>mu* on their repositories you can install it from source which is really easy.
<code>bash
git clone -b "release/1.6" https://github.com/djcb/mu/
cd mu
meson --prefix=/usr --buildtype=plain build
ninja -C build install
</code></p>

<h2>Installing Isync Or OfflineImap</h2>

<p>Both <em>Isync</em> And <em>Offlineimap</em> are great programs to download our mail into our inbox.
There isn&rsquo;t really that much difference, it just depends on which one you&rsquo;d like to install.
To Install <em>Isync</em> Or <em>Offlineimap</em> On <strong>Arch</strong>
<code>bash
pacman -S isync
pacman -S offlineimap
</code>
To Install <em>Isync</em> or <em>Offlineimap</em> On <strong>Debian</strong>
<code>bash
apt install isync
apt install offlineimap
</code></p>

<h2>Configuring Isync</h2>

<p>Configuring <em>Isync</em> is really easy however it depends on which options you&rsquo;d like to set.
By default if you gonna use <em>Gmail</em> like myself. you&rsquo;d wanna set some google options first .
If you have 2FA enabled, you should first set up an app password this will let&rsquo;s you control your <em>Gmail only</em> will a custom generated password. First head up to <a href="https://myaccount.google.com/apppasswords">Set Up App Password</a>, Select app as <strong>Mail</strong> and device as <strong>Custom</strong> and give it a name, it will generate a custom password.
<strong>Disclaimer</strong> Your password should no be shared with anyone except yourself and <em>Isync</em>
<strong>Extra</strong> As your password will be kept in <em>Isync</em> config file in plain text, you can avoid this and encrypt it using <strong>GPG</strong>. You can either use <strong>Pass</strong> utility if its installed on your device as a wrapper around <strong>GPG</strong> or use straight <strong>GPG</strong>.
To Crypt your password using <strong>pass</strong> command.
<code>bash
pass insert gmail_app
Enter password for test_gmail: *******
Retype password for test_gmail: *******
</code>
To Crypt your password using <strong>GPG</strong> command, First generate a new key if you don&rsquo;t have one yet .
```bash</p>

<h1>This will prompt you for email and a name and a password (Use a valid real mail if you gonna share ur key will others)</h1>

<h1>WARNING: DO NOT LOSE YOUR KEYS AND THE PASSWORD YOU USED TO CREATE THE KEYS OTHERWISE YOUR DATA WILL BE LOSE IF YOU LOSE THEM</h1>

<h1>ALWAYS BACKUP YOUR .gnupg AND .password-store FOLDER TO A USB_DRIVE OR AN EXTERNAL DRIVE OR IN THE CLOUD</h1>

<p>gpg &ndash;full-generate-key</p>

<h1>After u create your own key, find it through the following command</h1>

<p>gpg -K &ndash;keyid-format=long</p>

<h1>You&rsquo;ll get something like this</h1>

<h1>sec   rsa2048/84263A08F86B7E99 2020-06-17 [SC] [expires: 2022-06-17]</h1>

<h1>447FE384AAE41F357F5876FF84263A08F86B7E99</h1>

<h1>uid                 [ultimate] Ybenel <a href="&#x6d;&#x61;&#x69;&#108;&#116;&#x6f;&#x3a;&#114;&#x32;&#x64;&#114;&#x30;&#x64;&#110;&#64;&#x70;&#x6d;&#46;&#x6d;&#101;">&#114;&#50;&#100;&#x72;&#x30;&#x64;&#x6e;&#x40;&#x70;&#x6d;&#x2e;&#109;&#101;</a></h1>

<h1>ssb   rsa2048/C8D9741AC03BE89C 2020-06-17 [E] [expires: 2022-06-17]</h1>

<h1>Now you have your long key and ur short key, you can use whatever u want , now let&rsquo;s encrypt your file</h1>

<p>echo &ldquo;YOUR APP PASSWORD&rdquo; > gmail_app
gpg -e -r 84263A08F86B7E99 gmail_app</p>

<h1>This will create a new encrypted file called gmail_app.gpg, delete the gmail_app that contains plain text passowrd preferbly using shred</h1>

<p><code>
Before quickly setting up our configuration file let's create a mail folder, to do so .
</code>bash
mkdir -p ~/Mail/Gmail
<code>
Now we need to create our configuration file that is located in our HOME folder which will be called **~/.mbsyncrc** . And Let's put our configurations .
</code>bash
IMAPAccount gmail
Host imap.gmail.com
User USERMAIL@gmail.com
PassCmd &ldquo;gpg -q &ndash;for-your-eyes-only &ndash;no-tty -d ~/.password-store/gmail_app.gpg&rdquo;
SSLType IMAPS
CertificateFile /etc/ssl/certs/ca-certificates.crt</p>

<p>IMAPStore gmail-remote
Account gmail</p>

<p>MaildirStore gmail-local
Subfolders Verbatim
Path ~/Mail/Gmail/
Inbox ~/Mail/Gmail/Inbox</p>

<p>Channel gmail
Far :gmail-remote:
Near :gmail-local:
Patterns * ![Gmail]* &ldquo;[Gmail]/Sent Mail&rdquo; &ldquo;[Gmail]/All Mail&rdquo;
Create Both
Expunge Both
SyncState *
<code>
If you use a plain text password replace **PassCmd** With **Pass** And Put your password .
In **Patterns** This will download *Sent Mail* And *All Mail* and exclude everything else, you can add other folders as well as example , **"[Gmail]/Spam"** this will download the spam mail as well .
**Other Than GMAIL** if you use another email service you can replace the above config with the correct info , and replace gmail with a custom name, as a quick example .
</code>bash
IMAPAccount cock
Host mail.cock.li
User suckmycock11@cock.li
PassCmd &ldquo;gpg -q &ndash;for-your-eyes-only &ndash;no-tty -d ~/.password-store/cockli.gpg&rdquo;
SSLType IMAPS
CertificateFile /etc/ssl/certs/ca-certificates.crt</p>

<p>IMAPStore cock-remote
Account cock</p>

<p>MaildirStore cock-local
Subfolders Verbatim
Path ~/Mail/cock/
Inbox ~/Mail/cock/Inbox</p>

<p>Channel gmail
Far :gmail-remote:
Near :gmail-local:
Patterns * ![Inbox]* &ldquo;[Inbox]/Sent Mail&rdquo; &ldquo;[Inbox]/All Mail&rdquo;
Create Both
Expunge Both
SyncState *
```</p>

<h2>Configuring OfflineImap</h2>

<p><em>Offlineimap</em> Configurations is no different than <em>Isync</em> however it does support OAUTH2 authentication mechanism which u can use or not use if u want to and what it does is just the same as App Password But With Token. Keep in mind OAUTH2 does really need more little effort if you wanna use it. Starting Off With</p>

<h3>Setting Up GoogleApi</h3>

<p>GoogleAPI Is required to enable GmailApi , This will allow us to read and edit mail from our gmail account, to enable simply head over google api and search for gmailapi and click enable once its enabled search for generate token and copy it to an empty file for later.</p>

<h3>Installing gmail-oauth-tools</h3>

<p>In order for us to use the token we got earlier we need to install and use gmail-oauth-tools this will generate a refresh token that we will use later in configuring offlineimap.
To Install simply run .
<code>bash
git clone https://github.com/google/gmail-oauth2-tools Public/oauth2-tools
</code>
And run the following command to get your refresh token
<code>bash
python2 Public/oauth2-tools/python/oauth2.py --generate_oauth2_token --client_id=YOUR_CLIENT_ID --client_secret=YOUR_CLIENT_SECRET
</code>
To Get Your CLIENT-ID Head over to <a href="https://github.com/OfflineIMAP/offlineimap/blob/master/offlineimap.conf#L886-L894">Here</a> and read the steps .</p>

<h3>Adding The Configuration Files</h3>

<p>To Configure OfflineIMAP Put The Following Configurations In <strong>~/.offlineimaprc</strong>
```ini
[general]
accounts = Gmail
maxsyncaccounts = 3</p>

<h1>pythonfile = ~/.offlineimap.py</h1>

<p>[Account Gmail]
localrepository = Local
remoterepository = Remote</p>

<p>[Repository Local]
type = Maildir
localfolders = ~/Maildir
nametrans = lambda f: &lsquo;[Gmail]/&rsquo; + f if f in [&lsquo;Drafts&rsquo;, &lsquo;Starred&rsquo;, &lsquo;Important&rsquo;, &lsquo;Spam&rsquo;, &lsquo;Trash&rsquo;, &lsquo;All Mail&rsquo;, &lsquo;Sent Mail&rsquo;] else f</p>

<p>[Repository Remote]
type = IMAP
remotehost = imap.gmail.com
remoteuser = USERMAIL@gmail.com
auth_mechanisms = XOAUTH2
oauth2_client_id = CLIENT_ID
oauth2_client_secret = CLIENT_SECRET
oauth2_request_url = https://accounts.google.com/o/oauth2/token
oauth2_refresh_token = REFRESH_TOKEN
ssl = yes
maxconnections = 1
sslcacertfile = /etc/ssl/certs/ca-certificates.crt
ssl_version = tls1_2
folderfilter = lambda foldername: foldername in [&lsquo;INBOX&rsquo;, &lsquo;All Mail&rsquo;, &lsquo;Sent Mail&rsquo;]
nametrans = lambda f: f.replace(&lsquo;[Gmail]/&rsquo;, &lsquo;&rsquo;) if f.startswith(&lsquo;[Gmail]/&rsquo;) else f
<code>
Replace **CLIENT-ID,CLIENT-SECRET,REFRESH-TOKEN** with the tokens you've got.
In Case Of Using **GPG ENCRYPTED PASSWORD**
</code>python</p>

<h1>! /usr/bin/env python2</h1>

<h1>In side of offlineimap.py</h1>

<p>from subprocess import check_output</p>

<p>def get_pass():
    return check_output(&ldquo;gpg -dq ~/.password-store/gmail.gpg&rdquo;, shell=True).strip(&ldquo;\n&rdquo;)
<code>
</code>bash</p>

<h1>Incomment pythonfile in [general]</h1>

<h1>Remove oauth2* settings in [Repository Remote] and add</h1>

<p>remotepasseval = get_password()
<code>
In Case of Using **Plain Text Password** Or **Plain Password File**
</code>bash</p>

<h1>Remove oauth2* settings in [Repository Remote]</h1>

<h1>Add for plain text passowrd</h1>

<p>remotepass = mypassword</p>

<h1>Or Password file</h1>

<p>remotepassfile = ~/gmail_app
```</p>

<h2>Getting Mail</h2>

<p>Now Once You&rsquo;ve done all the previous steps , there&rsquo;s one last step to do and that is to get mail to your inbox, simply run the following command to start getting ur mail.</p>

<h3>Offlineimap</h3>

<p><code>bash
offlineimap
</code></p>

<h3>Mu</h3>

<p><code>bash
mu init -m ~/Mail --my-address=USERMAIL@gmail.com
mu index
</code>
And you&rsquo;re finally done, you&rsquo;ll now down all ur mail and it will be indexed automatically .</p>

<h2>Setting Up mu4e in emacs</h2>

<p>There isn&rsquo;t much to do with  <strong>mu4e</strong> in <strong>emacs</strong> besides adding our configurations.
My configurations is the following .
```lisp
(add-to-list &lsquo;load-path &ldquo;/usr/share/emacs/site-lisp/mu4e&rdquo;)
(with-eval-after-load 'mu4e
  (setq mu4e-context-policy 'ask-if-none
        mu4e-compose-context-policy 'pick-first)
  (setq mu4e-change-filenames-when-moving t)
  ;; refresh mail using isync every 10 minutes
  (setq mu4e-update-interval (* 10 60))
  ;; Comment out mu4e-mu-binary if u have mu installed in /usr/bin/ or something
  (setq mu4e-mu-binary &ldquo;~/Downloads/mu-1.6.6/mu/mu&rdquo;)
  (setq mu4e-get-mail-command &ldquo;mbsync -a&rdquo;)
  (setq mu4e-root-maildir &ldquo;~/Mail&rdquo;)
  (bind-key &ldquo;C-c C-m&rdquo; 'mu4e)
  (setq mu4e-html2text-command &ldquo;w3m -dump -T text/html -o display_link_number=true&rdquo;)
  ;; (setq mu4e-html2text-command &ldquo;html2markdown | grep -v &rsquo;&amp;nbsp_place_holder;&lsquo;&rdquo;)</p>

<p>  (set-email-account! &ldquo;Personal&rdquo;
                      &lsquo;((mu4e-sent-folder          . &ldquo;/Gmail/[Gmail]/Sent Mail&rdquo;)
                        (mu4e-drafts-folder        . &ldquo;/Gmail/[Gmail]/Drafts&rdquo;)
                        (mu4e-refile-folder        . &ldquo;/Gmail/[Gmail]/All Mail&rdquo;)
                        (mu4e-trash-folder         . &ldquo;/Gmail/[Gmail]/Trash&rdquo;)
                        (user-mail-address         . &ldquo;USERMAIL@gmail.com&rdquo;)
                        (user-full-name            . &ldquo;Dr Drunkenstein&rdquo;)
                        (mu4e-compose-signature    . &ldquo;Signed By Mando&rdquo;)
                        (smtpmail-smtp-user        . &ldquo;USERMAIL@gmail.com&rdquo;)
                        (smtpmail-smtp-server      . &ldquo;smtp.gmail.com&rdquo;)
                        (smtpmail-stream-type      . ssl)
                        (smtpmail-smtp-service     . 465))
                      t)</p>

<p>  (setq mu4e-maildir-shortcuts
        &lsquo;((&ldquo;/Gmail/inbox&rdquo;             . ?i)
          (&ldquo;/Gmail/[Gmail]/Sent Mail&rdquo; . ?s)
          (&ldquo;/Gmail/[Gmail]/Trash&rdquo;     . ?t)
          (&ldquo;/Gmail/[Gmail]/Drafts&rdquo;    . ?d)
          (&ldquo;/Gmail/[Gmail]/All Mail&rdquo;  . ?a))))
```</p>

<h3>Extra Configurations</h3>

<p>if you want mail notifications and modeline alert of how many mails u have unread , you&rsquo;ll need an extra package called <strong>mu4e-alert</strong>.
You can install it through <a href="https://melpa.org/#/mu4e-alert">Melpa</a>  using <strong>package-install</strong> or through <strong>use-package</strong>
My Configurations for it is .
```lisp
(use-package! mu4e-alert
  :after mu4e
  :config
  (setq doom-modeline-mu4e t)</p>

<p>  (mu4e-alert-enable-mode-line-display)
  (mu4e-alert-enable-notifications)</p>

<p>  (mu4e-alert-set-default-style &lsquo;libnotify)
  (map! :leader
        (:prefix (&ldquo;d&rdquo;. &ldquo;mu4e&rdquo;)
         :desc &ldquo;Disable Mu4e Modeline Alert&rdquo; &ldquo;d&rdquo; #'mu4e-alert-disable-mode-line-display
         :desc &ldquo;Enable Mu4e Modeline Alert&rdquo; &ldquo;i&rdquo; #'mu4e-alert-enable-mode-line-display))</p>

<p>  (defvar +mu4e-alert-bell-cmd &lsquo;(&ldquo;paplay&rdquo; . &ldquo;/usr/share/sounds/freedesktop/stereo/message.oga&rdquo;)
    &ldquo;Cons list with command to play a sound, and the sound file to play.
                 Disabled when set to nil.&rdquo;)</p>

<p>  (setq mu4e-alert-email-notification-types &lsquo;(subjects))
  (defun +mu4e-alert-grouped-mail-notification-formatter-with-bell (mail-group _all-mails)
    &ldquo;Default function to format MAIL-GROUP for notification.
                 ALL-MAILS are the all the unread emails&rdquo;
    (when +mu4e-alert-bell-cmd
      (start-process (car +mu4e-alert-bell-cmd) (cdr +mu4e-alert-bell-cmd)))
    (if (> (length mail-group) 1)
        (let<em> ((mail-count (length mail-group))
               (first-mail (car mail-group))
               (title-prefix (format &ldquo;You have %d unread emails&rdquo;
                                     mail-count))
               (field-value (mu4e-alert&ndash;get-group first-mail))
               (title-suffix (format (pcase mu4e-alert-group-by
                                       (<code>:from "from %s:")
                                       (</code>:to &ldquo;to %s:&rdquo;)
                                       (<code>:maildir "in %s:")
                                       (</code>:priority &ldquo;with %s priority:&rdquo;)
                                       (<code>:flags "with %s flags:"))
                                     field-value))
               (title (format "%s %s" title-prefix title-suffix)))
          (list :title title
                :body (s-join "\n"
                              (mapcar (lambda (mail)
                                        (format "%s&lt;b&gt;%s&lt;/b&gt; • %s"
                                                (cond
                                                 ((plist-get mail :in-reply-to) "⮩ ")
                                                 ((string-match-p "\\</code>Fwd:&ldquo;
                                                                  (plist-get mail :subject)) &rdquo; ⮯ &ldquo;)
                                                 (t "  &rdquo;))
                                                (truncate-string-to-width (caar (plist-get mail :from))
                                                                          20 nil nil t)
                                                (truncate-string-to-width
                                                 (replace-regexp-in-string &ldquo;\<code>Re: \\|\\</code>Fwd: &rdquo; &ldquo;&rdquo;
                                                                           (plist-get mail :subject))
                                                 40 nil nil t)))
                                      mail-group))))
      (let</em> ((new-mail (car mail-group))
             (subject (plist-get new-mail :subject))
             (sender (caar (plist-get new-mail :from))))
        (list :title sender :body subject))))
  (setq mu4e-alert-grouped-mail-notification-formatter #&rsquo;+mu4e-alert-grouped-mail-notification-formatter-with-bell))
```
And That&rsquo;s it .</p>

<h3>Screenshot</h3>

<p><img src="" alt="emacs_mu4e" /></p>

</body>
</html>
